{
	"info": {
		"_postman_id": "bbb9d47f-b4b9-4400-932f-a8cce8443abc",
		"name": "pq-user-creation",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "23827434"
	},
	"item": [
		{
			"name": "Login as SysAdmin",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = xml2Json(responseBody);",
							"var sessionId = jsonData['soapenv:Envelope']['soapenv:Body'].loginResponse.result.sessionId",
							"pm.environment.set(\"accessToken\", sessionId);",
							"var adminUserId = jsonData['soapenv:Envelope']['soapenv:Body'].loginResponse.result.userId",
							"pm.environment.set(\"adminUserId\", adminUserId)"
						],
						"type": "text/javascript"
					}
				}
			],
			"protocolProfileBehavior": {
				"disabledSystemHeaders": {
					"accept": true,
					"content-type": true
				}
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "text/xml"
					},
					{
						"key": "SOAPAction",
						"value": "login"
					},
					{
						"key": "charset",
						"value": "UTF-8",
						"type": "text"
					},
					{
						"key": "Accept",
						"value": "text/xml",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "<?xml version=\"1.0\" encoding=\"utf-8\" ?>\n<env:Envelope xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xmlns:env=\"http://schemas.xmlsoap.org/soap/envelope/\">\n  <env:Body>\n    <n1:login xmlns:n1=\"urn:partner.soap.sforce.com\">\n      <n1:username><![CDATA[{{username}}]]></n1:username>\n      <n1:password><![CDATA[{{password}}]]></n1:password>\n    </n1:login>\n  </env:Body>\n</env:Envelope>"
				},
				"url": {
					"raw": "{{baseUrl}}/services/Soap/u/{{version}}",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"Soap",
						"u",
						"{{version}}"
					]
				},
				"description": "Login to Salesforce"
			},
			"response": []
		},
		{
			"name": "StdPermSetGroup",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var statusCode = pm.response.code;",
							"",
							"var jsonData = JSON.parse(responseBody);",
							"if (jsonData.records[0] != null) {",
							"  jsonData.records.forEach(function (record) {",
							"    var profileName = record.DeveloperName;",
							"    if (profileName === 'SubscriptionManagementTaxAdmin') {",
							"      pm.environment.set(\"taxAdminPsgId\", record.Id);",
							"    } else if (profileName === 'SubscriptionManagementBillingAdmin') {",
							"      pm.environment.set(\"billingAdminPsgId\", record.Id);",
							"    } else if(profileName === 'SubscriptionManagementProductAndPricingAdmin'){",
							"        pm.environment.set(\"productAndPricingAdminPsgId\", record.Id);",
							"    }",
							"    else if(profileName === 'SubscriptionManagementSalesRep'){",
							"        pm.environment.set(\"salesRepPsgId\", record.Id);",
							"    }",
							"  });",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"type": "text",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/query/?q=SELECT Id, DeveloperName FROM PermissionSetGroup where DeveloperName in ('SubscriptionManagementTaxAdmin', 'SubscriptionManagementBillingAdmin', 'SubscriptionManagementProductAndPricingAdmin', 'SubscriptionManagementSalesRep')",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"query",
						""
					],
					"query": [
						{
							"key": "q",
							"value": "SELECT Id, DeveloperName FROM PermissionSetGroup where DeveloperName in ('SubscriptionManagementTaxAdmin', 'SubscriptionManagementBillingAdmin', 'SubscriptionManagementProductAndPricingAdmin', 'SubscriptionManagementSalesRep')"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Standard User Profile",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"var statusCode = pm.response.code;",
							"",
							"var jsonData = JSON.parse(responseBody);",
							"if (jsonData.records[0]!=null) {",
							"    pm.environment.set(\"standardUserProfileId\", jsonData.records[0].Id);",
							"}"
						],
						"type": "text/javascript"
					}
				}
			],
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"name": "Content-Type",
						"type": "text",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/query/?q=SELECT Id FROM Profile where Name = 'Standard User'",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"query",
						""
					],
					"query": [
						{
							"key": "q",
							"value": "SELECT Id FROM Profile where Name = 'Standard User'"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "TaxAdminUser",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"let orgUserNamePrefix = pm.environment.get(\"username\").split('@')[1];",
							"let newUserName = 'taxAdmin@' + orgUserNamePrefix;",
							"pm.environment.set(\"taxAdminUserName\", newUserName);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"",
							"var statusCode = jsonData.compositeResponse[0].httpStatusCode;",
							"if (statusCode == 201) {",
							"    jsonData.compositeResponse.forEach(function(response) {",
							"        var referenceId = response.referenceId;",
							"        if (referenceId === \"refUser\") {",
							"            pm.environment.set(\"taxAdminUserId\", response.body.id);",
							"        } ",
							"    })",
							"};"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"allOrNone\": true,\n    \"compositeRequest\": [\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User\",\n            \"referenceId\": \"refUser\",\n            \"body\": {\n                \"Username\": \"{{taxAdminUserName}}\",\n                \"ProfileId\": \"{{standardUserProfileId}}\",\n                \"Alias\": \"taxAdmin\",\n                \"Email\": \"{{$randomEmail}}\",\n                \"EmailEncodingKey\": \"ISO-8859-1\",\n                \"LastName\": \"TaxAdmin\",\n                \"LanguageLocaleKey\": \"en_US\",\n                \"LocaleSidKey\": \"en_US\",\n                \"TimeZoneSidKey\": \"America/Los_Angeles\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/PermissionSetAssignment/\",\n            \"referenceId\": \"taxAdminPsgAssignment\",\n            \"body\": {\n                \"AssigneeId\": \"@{refUser.id}\",\n                \"PermissionSetGroupId\": \"{{taxAdminPsgId}}\"\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/composite",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"composite"
					]
				}
			},
			"response": []
		},
		{
			"name": "BillingAdminUser",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"let orgUserNamePrefix = pm.environment.get(\"username\").split('@')[1];",
							"let newUserName = 'billingAdmin@' + orgUserNamePrefix;",
							"",
							"pm.environment.set(\"billingAdminUserName\", newUserName);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"var statusCode = jsonData.compositeResponse[0].httpStatusCode;",
							"",
							"jsonData.compositeResponse.forEach(function(response){",
							"    var referenceId = response.referenceId;",
							"    if(referenceId === \"refUser\") {",
							"        pm.environment.set(\"billingAdminUserId\", response.body.id);",
							"    } ",
							"});    "
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{accessToken}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"allOrNone\": true,\n    \"compositeRequest\": [\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User\",\n            \"referenceId\": \"refUser\",\n            \"body\": {\n                \"Username\": \"{{billingAdminUserName}}\",\n                \"Alias\": \"bAdmin\",\n                \"ProfileId\": \"{{standardUserProfileId}}\",\n                \"Email\": \"{{$randomEmail}}\",\n                \"EmailEncodingKey\": \"ISO-8859-1\",\n                \"LastName\": \"Cloudy\",\n                \"LanguageLocaleKey\": \"en_US\",\n                \"LocaleSidKey\": \"en_US\",\n                \"TimeZoneSidKey\": \"America/Los_Angeles\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/PermissionSetAssignment/\",\n            \"referenceId\": \"billingAdminPsgAssignment\",\n            \"body\": {\n                \"AssigneeId\": \"@{refUser.id}\",\n                \"PermissionSetGroupId\": \"{{billingAdminPsgId}}\"\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/composite",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"composite"
					]
				}
			},
			"response": []
		},
		{
			"name": "ProductAndPricingAdminUser",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"let orgUserNamePrefix = pm.environment.get(\"username\").split('@')[1];",
							"let newUserName = 'productAndPricingAdmin@' + orgUserNamePrefix;",
							"",
							"pm.environment.set(\"productAndPricingAdminUserName\", newUserName);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"var statusCode = jsonData.compositeResponse[0].httpStatusCode;",
							"if (statusCode == 201) {",
							"    jsonData.compositeResponse.forEach(function(response){",
							"        var referenceId = response.referenceId;",
							"        if(referenceId === \"refUser\"){",
							"            pm.environment.set(\"productAndPricingAdminUserId\", response.body.id);",
							"        } ",
							"    })",
							"};    "
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{accessToken}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"allOrNone\": true,\n    \"compositeRequest\": [\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User\",\n            \"referenceId\": \"refUser\",\n            \"body\": {\n                \"Username\": \"{{productAndPricingAdminUserName}}\",\n                \"ProfileId\": \"{{standardUserProfileId}}\",\n                \"Alias\": \"prodPr\",\n                \"Email\": \"{{$randomEmail}}\",\n                \"EmailEncodingKey\": \"ISO-8859-1\",\n                \"LastName\": \"Codey\",\n                \"LanguageLocaleKey\": \"en_US\",\n                \"LocaleSidKey\": \"en_US\",\n                \"TimeZoneSidKey\": \"America/Los_Angeles\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/PermissionSetAssignment/\",\n            \"referenceId\": \"productAndPricingAdminPsgAssignment\",\n            \"body\": {\n                \"AssigneeId\": \"@{refUser.id}\",\n                \"PermissionSetGroupId\": \"{{productAndPricingAdminPsgId}}\"\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/composite",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"composite"
					]
				}
			},
			"response": []
		},
		{
			"name": "SalesRep",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"let orgUserNamePrefix = pm.environment.get(\"username\").split('@')[1];",
							"let newUserName = 'salesRep@' + orgUserNamePrefix;",
							"",
							"pm.environment.set(\"salesRepUserName\", newUserName);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"var jsonData = JSON.parse(responseBody);",
							"var statusCode = jsonData.compositeResponse[0].httpStatusCode;",
							"if (statusCode == 201) {",
							"    jsonData.compositeResponse.forEach(function(response){",
							"        var referenceId = response.referenceId;",
							"        if(referenceId === \"refUser\"){",
							"            pm.environment.set(\"salesRepUserId\", response.body.id);",
							"        } ",
							"    })",
							"};    "
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"auth": {
					"type": "bearer",
					"bearer": [
						{
							"key": "token",
							"value": "{{accessToken}}",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"allOrNone\": true,\n    \"compositeRequest\": [\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User\",\n            \"referenceId\": \"refUser\",\n            \"body\": {\n                \"Username\": \"{{salesRepUserName}}\",\n                \"ProfileId\": \"{{standardUserProfileId}}\",\n                \"Alias\": \"salesRep\",\n                \"Email\": \"{{$randomEmail}}\",\n                \"EmailEncodingKey\": \"ISO-8859-1\",\n                \"LastName\": \"Salar\",\n                \"LanguageLocaleKey\": \"en_US\",\n                \"LocaleSidKey\": \"en_US\",\n                \"TimeZoneSidKey\": \"America/Los_Angeles\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/PermissionSetAssignment/\",\n            \"referenceId\": \"salesRepPsgAssignment\",\n            \"body\": {\n                \"AssigneeId\": \"@{refUser.id}\",\n                \"PermissionSetGroupId\": \"{{salesRepPsgId}}\"\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/composite",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"composite"
					]
				}
			},
			"response": []
		},
		{
			"name": "Password Reset Composite API",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"",
							""
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"allOrNone\": false,\n    \"compositeRequest\": [\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User/{{taxAdminUserId}}/password\",\n            \"referenceId\": \"taxAdminNewPassword\",\n            \"body\": {\n                \"NewPassword\": \"{{commonUserPassword}}\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User/{{billingAdminUserId}}/password\",\n            \"referenceId\": \"billingAdminNewPassword\",\n            \"body\": {\n                \"NewPassword\": \"{{commonUserPassword}}\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User/{{productAndPricingAdminUserId}}/password\",\n            \"referenceId\": \"productAndPricingAdminNewPassword\",\n            \"body\": {\n                \"NewPassword\": \"{{commonUserPassword}}\"\n            }\n        },\n        {\n            \"method\": \"POST\",\n            \"url\": \"/services/data/v{{version}}/sobjects/User/{{salesRepUserId}}/password\",\n            \"referenceId\": \"salesRepNewPassword\",\n            \"body\": {\n                \"NewPassword\": \"{{commonUserPassword}}\"\n            }\n        }\n    ]\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{baseUrl}}/services/data/v{{version}}/composite",
					"host": [
						"{{baseUrl}}"
					],
					"path": [
						"services",
						"data",
						"v{{version}}",
						"composite"
					]
				}
			},
			"response": []
		}
	]
}